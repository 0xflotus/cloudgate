<html>
    <head>
        <meta content="width=device-width, initial-scale=1, maximum-scale=1" name="viewport">
        <style>
            .line{
                float: left;
                width: 33%;
            }
            .fullLine{
                float: left;
                width: 100%;
            }
            .bloc{
                float: left;
                width: 92%;
                padding: 8px;
                margin-right: 10px;
                margin-bottom: 10px;
                background: #f1f1f1;
                border-radius: 8px;
                padding-top: 15px;
                padding-bottom: 15px;
                padding-left: 15px;
            }
            .bloc p{
                margin: 0;
                font-size: 26px;
                float: left;
                width: 100%;
            }
            .bloc span{
                margin: 0;
                font-size: 16px;
                float: left;
                width: 100%;
            }

            .inputsBox{
                float: left;
                width: 100%;
            }


            h2{
                color: gray;
                margin: 0;
                margin-top: 20px;
                float: left;
                width: 100%;
                margin-bottom: 8px;
            }

            h3{
                color: #959595;
            }

            .processItem{
                background: #f1f1f1;
                margin-bottom: 2px;
            }

            .systemTable{
                max-width: 100%;
                overflow: auto;
                max-height: 615px;
            }

            #global{
                margin-top: 10px; width: 99%; color: black; padding: 0.5%;float: left;
            }

            #system{
                float: left;
                width: 100%;
            }

            .tableHeader{
                background: #dbdbdb;
                font-weight: bold;
            }

            #vcores {
                float: left;
                width: 96%;
                height: 321px;
                background: #f1f1f1;
                border-radius: 8px;
                overflow: auto;
                padding-top: 20px;
            }

            .core {
                width: 40%;
                float: left;
                border: 1px solid gray;
                margin: 10px;
                padding: 10px;
            }

            @media only screen and (max-width: 1366px) {
                .core {
                    width: 38%;
                }
            }

            @media only screen and (max-width: 1024px) {
                .core {
                    width: 30%;
                }
            }

            @media only screen and (max-width: 768px) {
                .line{
                    float: left;
                    width: 100%;
                }
                #vcores{
                    width: 100%;
                }
                .core {
                    width: 36%;
                }
                .bloc{
                    width: 93%;
                }
            }

            
        </style>
    </head>

    <body>

        <div id='inputsBox'>
            <input id='txtInput' type='text' placeholder='Type a command ...'/> 
            <button onclick='SendMessage()'>SEND</button>
        </div>

        <div id='div_g' style='float:left; width: 99%; height: 300px;'></div>

        <div id='global'> 

            <div class="line">
                <h2>CPU</h2>
                <div id='vcores'>
                    
                </div>
            </div>
            
            <div class='line'>
                <h2>Global</h2>
                <div class='bloc'>
                    <p id='currentload'>... %</p>
                    <span>CPU Usage</span>
                </div>

                <div class='bloc'>
                    <p id='mem'>... GB</p>
                    <span>RAM Usage</span>
                </div>

                <div class='bloc'>
                    <p id='swap'>... GB</p>
                    <span>SWAP Usage</span>
                </div>

                <div class='bloc'>
                    <p id='uptime'>... Days</p>
                    <span>Server uptime in days</span>
                </div>

            </div>

            <div class="line">
                <h2>Network</h2>
                <div class='bloc'>
                    <p id='networkStats_totalRX'>...</p>
                    <span>Total Net inbound since boot</span>
                </div>

                <div class='bloc'>
                    <p id='networkStats_totalTX'>...</p>
                    <span>Total Net outbound since boot</span>
                </div>

                <div class='bloc'>
                    <p id='networkStats_RXSpeed'>...</p>
                    <span>Net inbound speed</span>
                </div>

                <div class='bloc'>
                    <p id='networkStats_TXSpeed'>...</p>
                    <span>Net outbound speed</span>
                </div>
            </div>


            
            <div class="line">
                <h2>Filesystem</h2>
                <div class='bloc' title="Bytes read since startup">
                    <p id='diskRX'>...</p>
                    <span>Total FS reads since boot</span>
                </div>

                <div class='bloc' title="Bytes written since startup">
                    <p id='diskWX'>...</p>
                    <span>Total FS writes since boot</span>
                </div>

                <div class='bloc'>
                    <p id='diskRXSpeed'>...</p>
                    <span>FS Bytes read/second</span>
                </div>

                <div class='bloc'>
                    <p id='diskWXSpeed'>...</p>
                    <span>FS Bytes write/second</span>
                </div>
            </div>

            
            <div class="line">
                <h2>Disk IO</h2>
                <div class='bloc' title="Bytes read since startup">
                    <p id='diskIORX'>...</p>
                    <span>Total IO Reads since boot</span>
                </div>

                <div class='bloc' title="Bytes written since startup">
                    <p id='diskIOWX'>...</p>
                    <span>Total IO Writes since boot</span>
                </div>

                <div class='bloc'>
                    <p id='diskIORXSpeed'>...</p>
                    <span>IO reads/second</span>
                </div>

                <div class='bloc'>
                    <p id='diskIOWXSpeed'>...</p>
                    <span>IO writes/second</span>
                </div>
            </div>

            <div class="line">
                <h2>Docker</h2>
                <div class='bloc'>
                    <p id='dockerRunning'>...</p>
                    <span>Running containers</span>
                </div>

                <div class='bloc'>
                    <p id='dockerStopped'>...</p>
                    <span>Stopped containers</span>
                </div>

                <div class='bloc'>
                    <p id='dockerPaused'>...</p>
                    <span>Paused containers</span>
                </div>

                <div class='bloc'>
                    <p id='dockerImages'>...</p>
                    <span>Docker images</span>
                </div>
            </div>


            <div class="fullLine">
                <h2>Processes</h2> <button onclick="Send('/processes')" style='float: left; margin-top: 24px; margin-bottom: 15px;'>Refresh</button>
              
                <div id='processes' style='width: 100%; float: left;'>
                    
                </div>
            </div>

            
            <div class="fullLine">
                <h2>Connections</h2> <button onclick="Send('/connections')" style='float: left; margin-top: 24px; margin-bottom: 15px;'>Refresh</button>
              
                <div id='connections' style='width: 100%; float: left;'>
                    
                </div>
            </div>

            
            <div class='fullLine' id='systemContainer'>
                <h2>System</h2>    
                <div id='system'></div>
            </div>

        </div>

        <div id='content' style='margin-top: 10px; width: 95%; color: black; padding: 15px;'> </div>
        
        
        <script src='js/pretty-bytes.js?v=2'></script>
        <script>

                var input = document.getElementById("txtInput");
                // Execute a function when the user releases a key on the keyboard
                input.addEventListener("keyup", function(event) {
                    if (event.keyCode === 13) {
                        // Cancel the default action, if needed
                        event.preventDefault();
                        SendMessage()
                    }
                });

                var shouldReconnect = true;
                function connect() {

                    var channel = getParamFromUrl("channel");
                    if ( channel == null ) {
                        channel = "global";
                    }

                    

                    var protocolPrefix = (window.location.protocol === 'https:') ? 'wss:' : 'ws:';
                    var rootURL = protocolPrefix + '//' + location.host;
                    var ws = new WebSocket(rootURL + '/monitoring?channel=' + channel + "&token=" + getParamFromUrl("token"));
                    var nbConnectRetry = 5;
                    globalWS = ws;
                    ws.onopen = function() {
                        nbConnectRetry = 0;
                    };

                    ws.onmessage = function(e) {
                        //console.log('Message:', e.data);

                        /*
                        var new_html = '<span class="line">' +  sanitizeHTML(e.data)  + '</span>';
                        var new_elem = document.createElement('div');
                        new_elem.innerHTML = new_html;

                        var content = document.getElementById('content');
                        content.appendChild(new_elem);
                        */

                        if ( e.data == "Unauthorized"){
                            shouldReconnect = false;
                            ws.close();
                        }
                        else{
                            var msg = JSON.parse(e.data);
                            if ( msg.type == "global" ){
                                //json2Table
                                var result = "";
                                result += json2Table([msg.cpu], "CPU");
                                result += json2Table(msg.blockDevices, "Block Devices");
                                result += json2Table(msg.diskLayout, "Disk Layout");
                                result += json2Table(msg.fsSize, "FS Size");
                                result += json2Table(msg.networkInterfaces, "Network Interfaces");
                                result += json2Table(msg.dockerContainers, "Docker Containers");
                                result += json2Table([msg.dockerInfo], "DockerInfo");
                                document.getElementById('system').innerHTML = result;

                                //build vcores
                                var cpus = msg.currentLoad.cpus;
                                var allCores = "";
                                for (var i = 0; i < cpus.length; i++){
                                    var curCore = cpus[i];
                                    var color = "";
                                    if ( curCore.load < 20 ) {
                                        color = "green";
                                    }
                                    else if ( curCore.load < 60 ) {
                                        color = "orange";
                                    }
                                    else {
                                        color = "red";
                                    }

                                    allCores += "<div class='core'> <div id='core" + i + "' style='background: " + color + "; width:" + curCore.load.toFixed(2) + "%; height: 10px; float: left;'> <span id='coreDetails" + i + "' style='font-size: 9px; font-weight: bold; margin-top: -22px;float: left;width: 60px;margin-left: -10px;'>C" + (i+1) +  ": " + curCore.load.toFixed(2) +  "%</span> </div> </div>";
                                }
                                document.getElementById('vcores').innerHTML = allCores
                            }
                            else if ( msg.type == "dynamic" ){
                                
                                document.getElementById('currentload').innerHTML = msg.currentLoad.currentload.toFixed(2) + " %";
                                //vcores
                                var cpus = msg.currentLoad.cpus;
                                var allCores = "";
                                for (var i = 0; i < cpus.length; i++){
                                    var curCore = cpus[i];
                                    var color = "";
                                    if ( curCore.load < 20 ) {
                                        color = "green";
                                    }
                                    else if ( curCore.load < 60 ) {
                                        color = "orange";
                                    }
                                    else {
                                        color = "red";
                                    }

                                    //allCores += "<div class='core' style='width: 100%; float:left;'> <div id='core" + i + "' style='background: " + color + "; width:" + curCore.load.toFixed(2) + "%; height: 10px; float: left;'></div> </div>";
                                    document.getElementById('core' + i).style.width = curCore.load.toFixed(2) + "%";
                                    document.getElementById('core' + i).style.background = color;
                                    document.getElementById('coreDetails' + i).innerHTML = "C" + (i+1) + ": " + curCore.load.toFixed(2) + "%";
                                    
                                }
                                //document.getElementById('vcores').innerHTML = allCores

                                document.getElementById('uptime').innerHTML = (msg.time.uptime*1000/8.64e+7).toFixed(5) + " Days";
                                
                                //var totalMemUsed = (msg.mem.total/1024/1024) - (msg.mem.free/1024/1024) - (msg.mem.available/1024/1024);
                                //used_mem = total_mem - (free_mem + buffers_mem + cached_mem)
                                var totalMemUsed = (msg.mem.total - (msg.mem.free + msg.mem.buffers + msg.mem.cached))/1024/1024;
                                

                                document.getElementById('mem').innerHTML = totalMemUsed.toFixed(0) + " / " + (msg.mem.total/1024/1024).toFixed(0) + "MB";
                                document.getElementById('swap').innerHTML = (msg.mem.swapused/1024/1024).toFixed(0) + " / " + (msg.mem.swaptotal/1024/1024).toFixed(0) + "MB";
                                
                                /*
                                let data = [
                                    [(+new Date())],
                                    [parseFloat(msg.currentLoad.currentload)],
                                    [parseFloat(totalMemUsed)],
                                    [msg.networkStats[0].tx_sec],
                                ];      
                                uplot2.setData(data);
                                */

                                var x = new Date();  // current time
                                var y = parseFloat(msg.currentLoad.currentload);
                                globalGraphData.push([x, y]);
                                globalGraph.updateOptions( { 'file': globalGraphData } );

                                document.getElementById('networkStats_totalRX').innerHTML = prettyBytes(msg.networkStats[0].rx_bytes);
                                document.getElementById('networkStats_totalTX').innerHTML = prettyBytes(msg.networkStats[0].tx_bytes);
                                document.getElementById('networkStats_RXSpeed').innerHTML = prettyBytes(msg.networkStats[0].rx_sec) + "/s";
                                document.getElementById('networkStats_TXSpeed').innerHTML = prettyBytes(msg.networkStats[0].tx_sec) + "/s";

                                if ( msg.disksIO != null ){
                                    document.getElementById('diskIORX').innerHTML = (msg.disksIO.rIO/1000/1000).toFixed(5) + " M";
                                    document.getElementById('diskIOWX').innerHTML = (msg.disksIO.wIO/1000/1000).toFixed(5) + " M";
                                    document.getElementById('diskIORXSpeed').innerHTML = (msg.disksIO.rIO_sec).toFixed(0) + "/s";
                                    document.getElementById('diskIOWXSpeed').innerHTML = (msg.disksIO.wIO_sec).toFixed(0) + "/s";
                                }
                                
                                if ( msg.fsStats != null ){
                                    document.getElementById('diskRX').innerHTML = prettyBytes(msg.fsStats.rx);
                                    document.getElementById('diskWX').innerHTML = prettyBytes(msg.fsStats.tx);
                                    document.getElementById('diskRXSpeed').innerHTML = prettyBytes(msg.fsStats.rx_sec) + "/s";
                                    document.getElementById('diskWXSpeed').innerHTML = prettyBytes(msg.fsStats.wx_sec) + "/s";
                                }           

                                //DockerInfos
                                if ( msg.dockerInfo != null ){
                                    document.getElementById('dockerRunning').innerHTML = msg.dockerInfo.containersRunning;
                                    document.getElementById('dockerStopped').innerHTML = msg.dockerInfo.containersStopped;
                                    document.getElementById('dockerPaused').innerHTML = msg.dockerInfo.containersPaused;
                                    document.getElementById('dockerImages').innerHTML = msg.dockerInfo.images;
                                }   
                                
                            }
                            else if ( msg.type == "processes" ){
                                
                                var allHTML = "";
                                var procList = msg.processes.list;
                                procList = procList.sort((a,b) => (a.pcpu < b.pcpu) ? 1 : ((b.pcpu < a.pcpu) ? -1 : 0));

                                allHTML += json2Table(procList, "");
                                document.getElementById('processes').innerHTML = allHTML;
                            }
                            else if ( msg.type == "networkConnections" ){
                                
                                var allHTML = "";
                                var conList = msg.networkConnections;
                                allHTML += json2Table(conList, "");
                                document.getElementById('connections').innerHTML = allHTML;
                            }
                            else if ( msg.type == "services" ){

                            }


                        }
                    };

                    ws.onclose = function(e) {
                        console.log('Socket is closed. Reconnect will be attempted in ' + nbConnectRetry + ' seconds.', e.reason);
                        if (shouldReconnect){
                            setTimeout(function() {
                                connect();
                            }, 1000*nbConnectRetry); //backoff mechanism
                        }
                    };

                    ws.onerror = function(err) {
                        console.error('Socket encountered error: ', err.message, 'Closing socket');
                        ws.close();

                        nbConnectRetry += 1;
                    };
                }

                connect();


                function SendMessage(){
                    var txt = document.getElementById('txtInput').value;
                    Send(txt);
                    document.getElementById('txtInput').value = "";
                }

                
                function Send(txt) {
                    
                    if ( globalWS.readyState != 1 ){
                        //websocket is closed, skip it ... (or queue it?)
                        return;
                    }

                    txt = JSON.stringify({
                        EXEC_CMD: txt
                    });

                    globalWS.send( encodeURIComponent(txt) );
                }

                var sanitizeHTML = function (str) {

                    return str;

                    var temp = document.createElement('div');
                    temp.textContent = str;
                    return temp.innerHTML;
                };

                function getParamFromUrl(n){var t=new RegExp("[?&]"+n+"=([^&#]*)").exec(window.location.href);return t==null?null:t[1]||0}

                //Heartbeat system to avoid cloudflare and other CDNs to close the channel
                setInterval(function(){
                    if ( globalWS.readyState != 1 ){
                        return;
                    }
                    globalWS.send( "[HEARTBEAT]" );
                }, 60*1000);



                function formatGB(val){
                    return val/1024/1024/1024;
                }

                function formatMB(val){
                    return val/1024/1024;
                }

                function formatKB(val){
                    return val/1024;
                }


                function json2Table(data, title){
                    
                    var result = "<div class='systemTable'>"; 

                    if ( title != "" && title != null ){
                        result += "<h3>" + title + "</h3>";
                    }

                    result += "<table style='width: 100%;' border=\"1\"> <tr class='tableHeader'>";

                    //header line
                    for (key in data[0]) {
                        result +='<td>' + key + '</td>';
                    }
                    result += "</tr>";

                    //rows
                    for (var i = 0; i < data.length; i++) {
                        result +='<tr>';
                        for (key in data[i]) {
                            if ( key == "size" || key == "used" ){
                                result +='<td>' + prettyBytes(parseInt(data[i][key])) + '</td>';
                            }
                            else if( key == "pcpu" || key == "pcpuu" || key == "pcpus" ){
                                result +='<td>' + parseFloat(data[i][key]).toFixed(2) + '</td>';
                            }
                            else{
                                var val = data[i][key];
                                if ( Array.isArray(val) ){
                                    result +='<td>' + "<div style='padding: 8px;'>" + json2Table(val, "") + "</div>" + '</td>';
                                }
                                else if (typeof val === 'object'){
                                    result +='<td>' + "<div style='padding: 8px;'>" + json2Table([val], "") + "</div>"  + '</td>';
                                }
                                else{
                                    result +='<td>' + data[i][key] + '</td>';
                                }
                                
                            }
                        }
                        result +='</tr>';
                    }

                    result +="</table><br/></div>";
                    return result;
                }

        </script>

        
        <script src="https://dygraphs.com/dygraph.js"></script>
        <script>
			var globalGraphData = [];
            var t = new Date();
            globalGraphData.push([t, 0]);
        
            var globalGraph = new Dygraph(document.getElementById("div_g"), globalGraphData,
            {
                drawPoints: true,
                showRoller: true,
                labels: ['Time', 'CPU']
            });
            
		</script>
        

    </body>
</html>